---
title: "analysis_flight"
author: "Sandra Tobon"
date: "29/05/2020"
output: html_document
---

First we will check how is the delay relative with the time in flight table 
```{r, include=FALSE}
library(tidyverse)
library(here)
library(lubridate)
library(tsibble)
library(feasts)
```

```{r}
flights <- read_csv(here("clean_data/flights.csv"))
flights <- flights %>%
  mutate(date = make_date(year, month, day)) 
```

For official records and stadistics in USA delay is when a flight departure 15 or more minutes later than the schedule time. Let's plot the number of delays in newark airport.
```{r}

flights %>%
  filter(origin == "EWR") %>%
  filter(between(dep_delay, 15, 2400)) %>%
  group_by(date) %>%
  summarise(count_delay = n()) %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = count_delay)) 
```
Here we cannot identify a real seasonal trend but we can visualize some patrons, for example most of the days the number of delays are higher than 10 and lower than 150. Between the middle of april to the middle of september (those are the summer months) aren't a very high pecks in delays, this also happen after the middle of october to end of november.
But for see exactly how bad is the situation let's check the proportion between flight that were delays and the total amount of flights
```{r}
flights %>%
  filter(origin == "EWR") %>%
  filter(dep_delay != 2500) %>%
  mutate(total_delay = ifelse(between(dep_delay, 15, 2400), 1, 0)) %>%
  group_by(date) %>%
  summarise(ratio_delay = sum(total_delay)/n()) %>%
  ggplot(aes(x = date)) +
    geom_line(aes(y = ratio_delay)) 
```
Here we can see that the ratio of flights that were delay are higher between january to april (the winter months) and other peek between august and september the hurracaine season in the atlantic. But so far we just plot the proportion of delays, we haven't made any correlation. 
Let's compare the ratio of delays in the 3 different airports in NY.
```{r}
flights %>%
  filter(dep_delay != 2500) %>%
  mutate(total_delay = ifelse(between(dep_delay, 15, 2400), 1, 0)) %>%
  group_by(origin, date) %>%
  summarise(ratio_delay = sum(total_delay)/n()) %>%
  ggplot(aes(x = date)) +
    geom_line(aes(y = ratio_delay, color = origin)) 
```

Actually Newark airport doesn't look too bad in comparation with other airports in NY, between october to december it looks to have more delays in proportion with other the other 2 airports.

Let's see if the newark delays ratio follow any particular trend
```{r}
flights %>%
  filter(origin == "EWR") %>%
  filter(dep_delay != 2500) %>%
  mutate(total_delay = ifelse(between(dep_delay, 15, 2400), 1, 0)) %>%
  group_by(origin, date) %>%
  summarise(ratio_delay = sum(total_delay)/n()) %>%
  as_tsibble() %>%
  model(STL(ratio_delay ~ trend(window = 12))) %>%
  components() %>%
  autoplot()
```
The ratio is higher between January to April and become more stable between april to June with few peeks betwwen June to September and decrease after september. Because here we only have information about one year we can't to confirm a seasonal patron. 

Let't us plot the boxplot with the delays value.
```{r}
flights %>%
  filter(origin == "EWR") %>%
  filter(dep_delay != 2500) %>%
  filter(between(dep_delay, 15, 2400)) %>%
  group_by(dep_delay) %>%
  summarise(count_delay = n()) %>%
  ggplot(aes( y = count_delay)) +
  geom_boxplot()

flights %>%
  filter(origin == "EWR") %>%
  filter(dep_delay != 2500) %>%
  filter(between(dep_delay, 15, 2400)) %>%
  summarise(median = median(dep_delay), mean = mean(dep_delay)) 
```
We can see that the distribution is skewet to the right that is the reason that the median is 50 and the mean is 72.62, because the mean is more sensible to the outlier. But this is a real data so even with the outliers we will not drop them.

```{r}
flights %>%
  filter(origin == "EWR") %>%
  filter(dep_delay != 2500) %>%
  filter(between(dep_delay, 15, 2400)) %>%
  ggplot(aes(x = dep_delay)) +
  geom_histogram(bins = 40)
```
Let's check how is the time line of the proportion of delays when they are above the mean.
```{r}
flights %>%
  filter(origin == "EWR") %>%
  filter(dep_delay != 2500) %>%
  mutate(total_delay = ifelse(between(dep_delay, 73, 2400), 1, 0)) %>%
  group_by(date) %>%
  summarise(ratio_delay = sum(total_delay)/n()) %>%
  ggplot(aes(x = date)) +
    geom_line(aes(y = ratio_delay)) 
```
Ac
```{r}
flights %>%
  filter(origin == "EWR") %>%
  filter(dep_delay != 2500) %>%
  mutate(total_delay = ifelse(between(dep_delay, 73, 2400), 1, 0)) %>%
  group_by(date) %>%
  summarise(ratio_delay = sum(total_delay)/n()) %>%
  as_tsibble() %>%
  model(STL(ratio_delay ~ trend(window = 12))) %>%
  components() %>%
  autoplot()
```

